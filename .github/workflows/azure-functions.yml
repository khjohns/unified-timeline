name: Azure Functions (Backend)

# DISABLED: Azure ikke i bruk ennå
# Fjern 'if: false' på jobbene når Azure er konfigurert

# =============================================================================
# Deployment workflow for backend to Azure Functions
#
# Triggers:
# - Push to main branch (backend changes only)
# - Manual trigger via workflow_dispatch
#
# Setup:
# 1. Create Azure Function App in Azure Portal (Python 3.11, Linux)
# 2. Download publish profile from Azure Portal > Function App > Get publish profile
# 3. Add as GitHub Secret: AZURE_FUNCTIONAPP_PUBLISH_PROFILE
# 4. Set AZURE_FUNCTIONAPP_NAME variable (or secret)
#
# Environment variables needed in Azure Function App Settings:
# - CATENDA_CLIENT_ID
# - CATENDA_CLIENT_SECRET
# - CATENDA_PROJECT_ID
# - SUPABASE_URL
# - SUPABASE_KEY
# - WEBHOOK_SECRET_PATH
# - MAGIC_LINK_SECRET_KEY
# =============================================================================

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - '!backend/tests/**'
      - '!backend/**/*.md'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  AZURE_FUNCTIONAPP_NAME: ${{ vars.AZURE_FUNCTIONAPP_NAME || 'unified-timeline-api' }}
  AZURE_FUNCTIONAPP_PACKAGE_PATH: 'backend'
  PYTHON_VERSION: '3.11'

jobs:
  build-and-test:
    if: false  # DISABLED - fjern når Azure er konfigurert
    runs-on: ubuntu-latest
    name: Build and Test

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: 'backend/requirements.txt'

      - name: Install dependencies
        run: |
          cd backend
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov

      - name: Run tests
        run: |
          cd backend
          python -m pytest tests/ -v --tb=short || echo "Tests completed with some failures"
        continue-on-error: true  # Don't block deploy on test failures for now

      - name: Verify syntax
        run: |
          cd backend
          python -m py_compile function_app.py
          python -m py_compile app.py
          echo "Syntax verification passed"

  deploy:
    if: false  # DISABLED - fjern når Azure er konfigurert
    runs-on: ubuntu-latest
    needs: build-and-test
    name: Deploy to Azure Functions
    environment:
      name: ${{ github.event.inputs.environment || 'staging' }}
      url: ${{ steps.deploy.outputs.webapp-url }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: 'backend/requirements.txt'

      - name: Install dependencies
        run: |
          cd ${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}
          python -m pip install --upgrade pip
          pip install -r requirements.txt --target=".python_packages/lib/site-packages"

      - name: Deploy to Azure Functions
        id: deploy
        uses: Azure/functions-action@v1
        with:
          app-name: ${{ env.AZURE_FUNCTIONAPP_NAME }}
          package: ${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}
          publish-profile: ${{ secrets.AZURE_FUNCTIONAPP_PUBLISH_PROFILE }}
          scm-do-build-during-deployment: false
          enable-oryx-build: false

      - name: Health check
        run: |
          echo "Waiting for deployment to stabilize..."
          sleep 30

          HEALTH_URL="https://${{ env.AZURE_FUNCTIONAPP_NAME }}.azurewebsites.net/api/health"
          echo "Checking health at: $HEALTH_URL"

          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$HEALTH_URL" || echo "000")

          if [ "$HTTP_STATUS" = "200" ]; then
            echo "Health check passed!"
          else
            echo "Warning: Health check returned status $HTTP_STATUS"
            echo "Deployment may still be initializing..."
          fi
        continue-on-error: true
