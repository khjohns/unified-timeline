openapi: 3.0.3
info:
  title: KOE Backend API
  description: 'Event Sourcing API for NS 8407 change order claims (Krav om Endringsordre).


    ## Authentication

    - **CSRF Token**: Required for POST/PUT/DELETE via `X-CSRF-Token` header

    - **Magic Link**: Required for case operations via `Authorization: Bearer <token>`
    header


    ## Event Sourcing

    All state changes are recorded as immutable events. State is computed by replaying
    events.

    Optimistic concurrency control via `expected_version` prevents conflicts.'
  version: 1.0.0
  contact:
    name: KOE Development Team
servers:
- url: http://localhost:8080
  description: Local development
tags:
- name: Events
  description: Event submission and case state management
- name: CloudEvents
  description: CloudEvents v1.0 support - schemas and format negotiation
- name: Forsering
  description: Forsering (acceleration) cases per NS 8407 §33.8
- name: Endringsordre
  description: Endringsordre (change order) cases per NS 8407 §31.3
- name: Utility
  description: Authentication and utility endpoints
- name: Webhooks
  description: Catenda webhook integration
paths:
  /api/csrf-token:
    get:
      tags:
      - Utility
      summary: Get CSRF token
      description: Retrieve a CSRF token for state-changing requests
      operationId: getCsrfToken
      responses:
        '200':
          description: CSRF token generated
          content:
            application/json:
              schema:
                type: object
                properties:
                  csrfToken:
                    type: string
                  expiresIn:
                    type: integer
                    example: 3600
  /api/magic-link/verify:
    get:
      tags:
      - Utility
      summary: Verify magic link token
      operationId: verifyMagicLink
      parameters:
      - name: token
        in: query
        required: true
        schema:
          type: string
      responses:
        '200':
          description: Token is valid
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  sakId:
                    type: string
        '403':
          description: Invalid or expired token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /api/health:
    get:
      tags:
      - Utility
      summary: Health check
      operationId: healthCheck
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: healthy
                  service:
                    type: string
                    example: koe-backend
  /api/metadata/by-topic/{topic_id}:
    get:
      tags:
      - Utility
      summary: Get case metadata by Catenda topic ID
      description: Retrieve case metadata based on Catenda topic ID. Used by test
        scripts to verify webhook processing.
      operationId: getMetadataByTopic
      parameters:
      - name: topic_id
        in: path
        required: true
        schema:
          type: string
          format: uuid
        description: Catenda topic GUID
      responses:
        '200':
          description: Case metadata found
          content:
            application/json:
              schema:
                type: object
                properties:
                  sak_id:
                    type: string
                    example: SAK-20251218-001
                  catenda_topic_id:
                    type: string
                    format: uuid
                  cached_title:
                    type: string
                    nullable: true
                  cached_status:
                    type: string
                    nullable: true
                  created_at:
                    type: string
                    format: date-time
                    nullable: true
        '404':
          description: No case found for topic
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: No case found for topic
                  topic_id:
                    type: string
  /api/validate-user:
    post:
      tags:
      - Utility
      summary: Validate user in Catenda project
      description: Validates if an email belongs to a user in the Catenda project.
        Used to verify users before allowing them to sign forms.
      operationId: validateUser
      security:
      - csrfToken: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
              - email
              - sakId
              properties:
                email:
                  type: string
                  format: email
                  description: User email to validate
                sakId:
                  type: string
                  description: Case ID to check project membership against
      responses:
        '200':
          description: User found in project
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  name:
                    type: string
                    description: User's full name
                  email:
                    type: string
                    format: email
                  company:
                    type: string
                    description: User's company
        '400':
          description: Missing required parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: User not found in project or case not found
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: false
                  error:
                    type: string
                    example: Brukeren er ikke medlem i dette Catenda-prosjektet.
  /api/events:
    post:
      tags:
      - Events
      summary: Submit event
      description: 'Submit a single event to a case with optimistic concurrency control.


        **Business Rules:**

        - Grunnlag must be submitted before vederlag/frist claims

        - Version must match current state version'
      operationId: submitEvent
      security:
      - csrfToken: []
      - magicLink: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/EventSubmission'
            examples:
              grunnlag:
                summary: Submit grunnlag
                value:
                  sak_id: SAK-20251218-001
                  expected_version: 1
                  event:
                    event_type: grunnlag_opprettet
                    aktor: Ola Nordmann
                    aktor_rolle: TE
                    data:
                      tittel: Forsinket tegningsunderlag uke 45
                      hovedkategori: ENDRING
                      underkategori: IRREG
                      beskrivelse: Mottok pålegg om endring
                      dato_oppdaget: '2025-12-18'
              vederlag:
                summary: Submit vederlag
                value:
                  sak_id: SAK-20251218-001
                  expected_version: 2
                  event:
                    event_type: vederlag_krav_sendt
                    aktor: Ola Nordmann
                    aktor_rolle: TE
                    data:
                      metode: ENHETSPRISER
                      belop_direkte: 150000.0
                      begrunnelse: Tillegg for endring
      responses:
        '201':
          description: Event submitted successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EventSubmissionResponse'
        '400':
          description: Validation error or business rule violation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                validation:
                  summary: Validation error with valid options
                  value:
                    success: false
                    error: VALIDATION_ERROR
                    message: Ugyldig underkategori 'INSTRUKS' for hovedkategori 'ENDRING'
                    field: underkategori
                    valid_options:
                      hovedkategori: ENDRING
                      underkategorier:
                      - EO
                      - IRREG
                      - SVAR_VARSEL
                      - LOV_GJENSTAND
                      - LOV_PROSESS
                      - GEBYR
                      - SAMORD
                business_rule:
                  summary: Business rule violation
                  value:
                    success: false
                    error: BUSINESS_RULE_VIOLATION
                    rule: GRUNNLAG_REQUIRED
                    message: Grunnlag må være sendt før du kan sende krav
        '401':
          description: Missing or invalid authentication
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '409':
          description: Version conflict
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VersionConflictError'
  /api/events/batch:
    post:
      tags:
      - Events
      summary: Submit batch of events
      description: Submit multiple events atomically (all-or-nothing)
      operationId: submitEventBatch
      security:
      - csrfToken: []
      - magicLink: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
              - sak_id
              - expected_version
              - events
              properties:
                sak_id:
                  type: string
                expected_version:
                  type: integer
                events:
                  type: array
                  items:
                    $ref: '#/components/schemas/Event'
      responses:
        '201':
          description: All events submitted
        '400':
          description: Validation error
        '409':
          description: Version conflict
  /api/cases:
    get:
      tags:
      - Events
      summary: List all cases
      description: 'List all cases with metadata from the sak_metadata table.


        Supports filtering by case type (sakstype).

        Results are sorted by last_event_at descending (most recent first).'
      operationId: listCases
      security:
      - magicLink: []
      parameters:
      - name: sakstype
        in: query
        required: false
        schema:
          type: string
          enum:
          - standard
          - forsering
          - endringsordre
        description: Filter by case type
      responses:
        '200':
          description: List of cases
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CaseListResponse'
  /api/cases/{sak_id}/state:
    get:
      tags:
      - Events
      summary: Get case state
      description: Get computed state for a case
      operationId: getCaseState
      security:
      - magicLink: []
      parameters:
      - name: sak_id
        in: path
        required: true
        schema:
          type: string
        example: SAK-20251218-001
      responses:
        '200':
          description: Case state
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CaseStateResponse'
        '404':
          description: Case not found
  /api/cases/{sak_id}/timeline:
    get:
      tags:
      - Events
      summary: Get case timeline
      description: Get full event timeline for UI display
      operationId: getCaseTimeline
      security:
      - magicLink: []
      parameters:
      - name: sak_id
        in: path
        required: true
        schema:
          type: string
      responses:
        '200':
          description: Event timeline
        '404':
          description: Case not found
  /api/cases/{sak_id}/historikk:
    get:
      tags:
      - Events
      summary: Get case history
      description: Get revision history for vederlag and frist tracks
      operationId: getCaseHistory
      security:
      - magicLink: []
      parameters:
      - name: sak_id
        in: path
        required: true
        schema:
          type: string
      responses:
        '200':
          description: Revision history
        '404':
          description: Case not found
  /webhook/catenda/{secret_path}:
    post:
      tags:
      - Webhooks
      summary: Catenda webhook
      description: 'Receives webhook events from Catenda.


        **Note:** Topics created via API may not trigger webhooks from Catenda.'
      operationId: catendaWebhook
      parameters:
      - name: secret_path
        in: path
        required: true
        schema:
          type: string
        description: Secret path for webhook authentication
      requestBody:
        content:
          application/json:
            schema:
              type: object
      responses:
        '200':
          description: Webhook processed
        '401':
          description: Invalid secret path
  /api/forsering/opprett:
    post:
      tags:
      - Forsering
      summary: Create forsering case
      description: 'Create a new forsering (acceleration) case based on rejected deadline
        extensions.


        Per NS 8407 §33.8: When BH rejects a justified deadline extension claim,

        TE can treat it as an order to accelerate if the cost is within 30% of

        the liquidated damages that would have accrued.'
      operationId: createForsering
      security:
      - csrfToken: []
      - magicLink: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
              - avslatte_sak_ids
              - estimert_kostnad
              - dagmulktsats
              - begrunnelse
              properties:
                avslatte_sak_ids:
                  type: array
                  items:
                    type: string
                  description: IDs of rejected deadline extension cases
                estimert_kostnad:
                  type: number
                  description: Estimated acceleration cost
                dagmulktsats:
                  type: number
                  description: Liquidated damages rate per day
                begrunnelse:
                  type: string
                  description: Justification
                avslatte_dager:
                  type: integer
                  description: Total rejected days (auto-calculated if omitted)
      responses:
        '201':
          description: Forsering case created
        '400':
          description: Validation error (e.g., cost exceeds 30% limit)
  /api/forsering/kandidater:
    get:
      tags:
      - Forsering
      summary: Get candidate KOE cases for forsering
      description: 'Get KOE cases that can be used for a forsering claim.


        A KOE is a candidate if:

        - It has sakstype=''standard'' (not forsering/endringsordre)

        - The deadline claim was rejected by BH (bh_resultat=''avslatt'')


        **Note:** No authentication required for this endpoint.'
      operationId: getForseringKandidater
      responses:
        '200':
          description: List of candidate cases
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  kandidat_saker:
                    type: array
                    items:
                      type: object
                      properties:
                        sak_id:
                          type: string
                        tittel:
                          type: string
                        avslatte_dager:
                          type: integer
                        catenda_topic_id:
                          type: string
  /api/forsering/{sak_id}/kontekst:
    get:
      tags:
      - Forsering
      summary: Get forsering context
      description: Get complete context including related cases, states, and events
      operationId: getForseringKontekst
      security:
      - magicLink: []
      parameters:
      - name: sak_id
        in: path
        required: true
        schema:
          type: string
      responses:
        '200':
          description: Forsering context with related cases
  /api/forsering/valider:
    post:
      tags:
      - Forsering
      summary: Validate 30% rule
      description: Check if estimated cost is within the 30% limit (dagmulkt + 30%)
      operationId: validateForsering
      security:
      - magicLink: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
              - estimert_kostnad
              - avslatte_dager
              - dagmulktsats
              properties:
                estimert_kostnad:
                  type: number
                avslatte_dager:
                  type: integer
                dagmulktsats:
                  type: number
      responses:
        '200':
          description: Validation result
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  er_gyldig:
                    type: boolean
                  maks_kostnad:
                    type: number
                  prosent_av_maks:
                    type: number
  /api/forsering/{sak_id}/relaterte:
    get:
      tags:
      - Forsering
      summary: Get related cases for forsering
      description: Get all KOE cases related to a forsering case (rejected frist claims)
      operationId: getForseringRelaterte
      security:
      - magicLink: []
      parameters:
      - name: sak_id
        in: path
        required: true
        schema:
          type: string
      responses:
        '200':
          description: List of related cases
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  sak_id:
                    type: string
                  relaterte_saker:
                    type: array
                    items:
                      type: object
                      properties:
                        relatert_sak_id:
                          type: string
                        relatert_sak_tittel:
                          type: string
                        bimsync_issue_board_ref:
                          type: string
                        bimsync_issue_number:
                          type: integer
  /api/forsering/{sak_id}/relatert:
    post:
      tags:
      - Forsering
      summary: Add related case to forsering
      description: Add a KOE case as related to the forsering
      operationId: addForseringRelatert
      security:
      - csrfToken: []
      - magicLink: []
      parameters:
      - name: sak_id
        in: path
        required: true
        schema:
          type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
              - koe_sak_id
              properties:
                koe_sak_id:
                  type: string
                  description: ID of KOE case to add
      responses:
        '200':
          description: KOE added to forsering
  /api/forsering/{sak_id}/relatert/{koe_sak_id}:
    delete:
      tags:
      - Forsering
      summary: Remove related case from forsering
      operationId: removeForseringRelatert
      security:
      - csrfToken: []
      - magicLink: []
      parameters:
      - name: sak_id
        in: path
        required: true
        schema:
          type: string
      - name: koe_sak_id
        in: path
        required: true
        schema:
          type: string
      responses:
        '200':
          description: KOE removed from forsering
  /api/forsering/{sak_id}/bh-respons:
    post:
      tags:
      - Forsering
      summary: Register BH response to forsering
      description: BH accepts or rejects the forsering claim
      operationId: bhResponsForsering
      security:
      - csrfToken: []
      - magicLink: []
      parameters:
      - name: sak_id
        in: path
        required: true
        schema:
          type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
              - aksepterer
              - begrunnelse
              properties:
                aksepterer:
                  type: boolean
                  description: Whether BH accepts the forsering
                godkjent_kostnad:
                  type: number
                  description: Approved cost (may be lower than estimated)
                begrunnelse:
                  type: string
                  description: Justification for decision
                expected_version:
                  type: integer
                  description: Expected version for optimistic concurrency
      responses:
        '200':
          description: BH response registered
          content:
            application/json:
              schema:
                allOf:
                - type: object
                  properties:
                    success:
                      type: boolean
                    message:
                      type: string
                    state:
                      type: object
                    version:
                      type: integer
                - $ref: '#/components/schemas/CatendaSyncStatus'
        '409':
          description: Concurrency conflict - version mismatch
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConcurrencyConflictError'
  /api/forsering/{sak_id}/stopp:
    post:
      tags:
      - Forsering
      summary: Stop active forsering
      description: Stop an ongoing forsering and record incurred costs
      operationId: stoppForsering
      security:
      - csrfToken: []
      - magicLink: []
      parameters:
      - name: sak_id
        in: path
        required: true
        schema:
          type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
              - begrunnelse
              properties:
                begrunnelse:
                  type: string
                  description: Reason for stopping
                paalopte_kostnader:
                  type: number
                  description: Incurred costs at time of stop
                expected_version:
                  type: integer
                  description: Expected version for optimistic concurrency
      responses:
        '200':
          description: Forsering stopped
          content:
            application/json:
              schema:
                allOf:
                - type: object
                  properties:
                    success:
                      type: boolean
                    message:
                      type: string
                    dato_stoppet:
                      type: string
                      format: date
                    state:
                      type: object
                    version:
                      type: integer
                - $ref: '#/components/schemas/CatendaSyncStatus'
        '409':
          description: Concurrency conflict - version mismatch
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConcurrencyConflictError'
  /api/forsering/{sak_id}/kostnader:
    put:
      tags:
      - Forsering
      summary: Update incurred costs
      description: Update the incurred costs for an active forsering
      operationId: oppdaterForseringKostnader
      security:
      - csrfToken: []
      - magicLink: []
      parameters:
      - name: sak_id
        in: path
        required: true
        schema:
          type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
              - paalopte_kostnader
              properties:
                paalopte_kostnader:
                  type: number
                  description: Current incurred costs
                kommentar:
                  type: string
                  description: Optional comment on update
                expected_version:
                  type: integer
                  description: Expected version for optimistic concurrency
      responses:
        '200':
          description: Costs updated
          content:
            application/json:
              schema:
                allOf:
                - type: object
                  properties:
                    success:
                      type: boolean
                    message:
                      type: string
                    state:
                      type: object
                    version:
                      type: integer
                - $ref: '#/components/schemas/CatendaSyncStatus'
        '409':
          description: Concurrency conflict - version mismatch
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConcurrencyConflictError'
  /api/forsering/by-relatert/{sak_id}:
    get:
      tags:
      - Forsering
      summary: Find forsering cases referencing a KOE
      description: Find all forsering cases that reference a given KOE case. Used
        for back-links.
      operationId: findForseringerForSak
      security:
      - magicLink: []
      parameters:
      - name: sak_id
        in: path
        required: true
        schema:
          type: string
        description: KOE case ID to search for
      responses:
        '200':
          description: List of forsering cases referencing this KOE
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  forseringer:
                    type: array
                    items:
                      type: object
                      properties:
                        forsering_sak_id:
                          type: string
                        tittel:
                          type: string
                        status:
                          type: string
                        estimert_kostnad:
                          type: number
  /api/endringsordre/opprett:
    post:
      tags:
      - Endringsordre
      summary: Create endringsordre case
      description: 'Create a new endringsordre (change order) case.


        Per NS 8407 §31.3: An endringsordre is the formal document confirming

        a contract change. It can aggregate multiple KOE cases.'
      operationId: createEndringsordre
      security:
      - csrfToken: []
      - magicLink: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
              - eo_nummer
              - beskrivelse
              properties:
                eo_nummer:
                  type: string
                  example: EO-001
                beskrivelse:
                  type: string
                koe_sak_ids:
                  type: array
                  items:
                    type: string
                konsekvenser:
                  type: object
                  properties:
                    sha:
                      type: boolean
                    kvalitet:
                      type: boolean
                    fremdrift:
                      type: boolean
                    pris:
                      type: boolean
                    annet:
                      type: boolean
                kompensasjon_belop:
                  type: number
                frist_dager:
                  type: integer
      responses:
        '201':
          description: Endringsordre created
        '400':
          description: Validation error
  /api/endringsordre/kandidater:
    get:
      tags:
      - Endringsordre
      summary: Get candidate KOE cases for endringsordre
      description: 'Get KOE cases that can be added to an endringsordre.


        **Note:** No authentication required for this endpoint.'
      operationId: getEOKandidater
      responses:
        '200':
          description: List of candidate cases
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  kandidat_saker:
                    type: array
                    items:
                      type: object
                      properties:
                        sak_id:
                          type: string
                        tittel:
                          type: string
                        overordnet_status:
                          type: string
                        sum_godkjent:
                          type: number
                        godkjent_dager:
                          type: integer
  /api/endringsordre/{sak_id}/kontekst:
    get:
      tags:
      - Endringsordre
      summary: Get endringsordre context
      description: Get complete context including related KOE cases, states, and events
      operationId: getEOKontekst
      security:
      - magicLink: []
      parameters:
      - name: sak_id
        in: path
        required: true
        schema:
          type: string
      responses:
        '200':
          description: Endringsordre context with related cases
  /api/endringsordre/{sak_id}/koe:
    post:
      tags:
      - Endringsordre
      summary: Add KOE to endringsordre
      operationId: addKOEToEO
      security:
      - csrfToken: []
      - magicLink: []
      parameters:
      - name: sak_id
        in: path
        required: true
        schema:
          type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
              - koe_sak_id
              properties:
                koe_sak_id:
                  type: string
      responses:
        '200':
          description: KOE added successfully
  /api/endringsordre/{sak_id}/koe/{koe_sak_id}:
    delete:
      tags:
      - Endringsordre
      summary: Remove KOE from endringsordre
      operationId: removeKOEFromEO
      security:
      - csrfToken: []
      - magicLink: []
      parameters:
      - name: sak_id
        in: path
        required: true
        schema:
          type: string
      - name: koe_sak_id
        in: path
        required: true
        schema:
          type: string
      responses:
        '200':
          description: KOE removed successfully
  /api/endringsordre/{sak_id}/relaterte:
    get:
      tags:
      - Endringsordre
      summary: Get related KOE cases for endringsordre
      description: Get all KOE cases included in an endringsordre
      operationId: getEORelaterte
      security:
      - magicLink: []
      parameters:
      - name: sak_id
        in: path
        required: true
        schema:
          type: string
      responses:
        '200':
          description: List of related KOE cases
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  sak_id:
                    type: string
                  relaterte_saker:
                    type: array
                    items:
                      type: object
                      properties:
                        relatert_sak_id:
                          type: string
                        relatert_sak_tittel:
                          type: string
                        bimsync_issue_board_ref:
                          type: string
                        bimsync_issue_number:
                          type: integer
  /api/endringsordre/by-relatert/{sak_id}:
    get:
      tags:
      - Endringsordre
      summary: Find endringsordre cases referencing a KOE
      description: Find all endringsordre cases that include a given KOE case. Used
        for back-links.
      operationId: findEOerForKOE
      security:
      - magicLink: []
      parameters:
      - name: sak_id
        in: path
        required: true
        schema:
          type: string
        description: KOE case ID to search for
      responses:
        '200':
          description: List of endringsordre cases including this KOE
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  endringsordrer:
                    type: array
                    items:
                      type: object
                      properties:
                        eo_sak_id:
                          type: string
                        eo_nummer:
                          type: string
                        dato_utstedt:
                          type: string
                          format: date
                        status:
                          type: string
  /api/cloudevents/schemas:
    get:
      tags:
      - CloudEvents
      summary: List all event data schemas
      description: 'List all available event types with their CloudEvents type names

        and links to their JSON schemas.


        This endpoint helps clients discover available event types and

        their data schemas for validation.'
      operationId: listCloudEventSchemas
      responses:
        '200':
          description: List of event schemas
          content:
            application/json:
              schema:
                type: object
                properties:
                  namespace:
                    type: string
                    example: no.oslo.koe
                  specversion:
                    type: string
                    example: '1.0'
                  event_types:
                    type: array
                    items:
                      type: object
                      properties:
                        event_type:
                          type: string
                        cloudevents_type:
                          type: string
                        schema_url:
                          type: string
                        has_data_schema:
                          type: boolean
  /api/cloudevents/schemas/{event_type}:
    get:
      tags:
      - CloudEvents
      summary: Get JSON Schema for event type
      description: 'Get the JSON Schema that describes the `data` attribute for events

        of the specified type. Use with CloudEvents `dataschema` attribute.'
      operationId: getEventSchema
      parameters:
      - name: event_type
        in: path
        required: true
        schema:
          type: string
        example: grunnlag_opprettet
      responses:
        '200':
          description: JSON Schema for event data
          content:
            application/schema+json:
              schema:
                type: object
                description: JSON Schema (draft-07)
        '404':
          description: Unknown event type or no schema available
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /api/cloudevents/envelope-schema:
    get:
      tags:
      - CloudEvents
      summary: Get CloudEvents envelope schema
      description: 'Get the JSON Schema for the CloudEvents envelope structure,

        including all standard and extension attributes used by this API.'
      operationId: getCloudEventEnvelopeSchema
      parameters:
      - name: format
        in: query
        schema:
          type: string
          enum:
          - jsonschema
          - openapi
          default: jsonschema
        description: Output format
      responses:
        '200':
          description: CloudEvents envelope schema
          content:
            application/schema+json:
              schema:
                type: object
  /api/cloudevents/all-schemas:
    get:
      tags:
      - CloudEvents
      summary: Get all schemas in one response
      description: Get envelope schema and all data schemas. Useful for caching.
      operationId: getAllCloudEventSchemas
      responses:
        '200':
          description: All schemas
          content:
            application/json:
              schema:
                type: object
                properties:
                  namespace:
                    type: string
                  specversion:
                    type: string
                  envelope:
                    type: object
                  data_schemas:
                    type: object
                    additionalProperties:
                      type: object
components:
  securitySchemes:
    csrfToken:
      type: apiKey
      in: header
      name: X-CSRF-Token
    magicLink:
      type: http
      scheme: bearer
  schemas:
    EventType:
      type: string
      enum:
      - grunnlag_opprettet
      - grunnlag_oppdatert
      - grunnlag_trukket
      - vederlag_krav_sendt
      - vederlag_krav_oppdatert
      - vederlag_krav_trukket
      - frist_krav_sendt
      - frist_krav_oppdatert
      - frist_krav_spesifisert
      - frist_krav_trukket
      - respons_grunnlag
      - respons_grunnlag_oppdatert
      - respons_vederlag
      - respons_vederlag_oppdatert
      - respons_frist
      - respons_frist_oppdatert
      - forsering_varsel
      - forsering_respons
      - forsering_stoppet
      - forsering_kostnader_oppdatert
      - forsering_koe_lagt_til
      - forsering_koe_fjernet
      - sak_opprettet
      - eo_opprettet
      - eo_koe_lagt_til
      - eo_koe_fjernet
      - eo_utstedt
      - eo_akseptert
      - eo_bestridt
      - eo_revidert
      description: Type of event in the system
    VederlagsMetode:
      type: string
      enum:
      - ENHETSPRISER
      - REGNINGSARBEID
      - FASTPRIS_TILBUD
      description: 'Compensation method (NS 8407):

        - ENHETSPRISER: Unit prices (§34.3)

        - REGNINGSARBEID: Cost-plus with estimate (§30.2/§34.4)

        - FASTPRIS_TILBUD: Fixed price / Tender (§34.2.1)'
    FristVarselType:
      type: string
      enum:
      - varsel
      - spesifisert
      - begrunnelse_utsatt
      description: 'Warning type for deadline extension:

        - noytralt: Preliminary warning (§33.4)

        - spesifisert: Specified claim with days (§33.6.1)

        - begge: Both preliminary and specified'
    Hovedkategori:
      type: string
      enum:
      - ENDRING
      - SVIKT
      - ANDRE
      - FORCE_MAJEURE
      description: 'Main category for grounds (NS 8407 §33.1):

        - ENDRING: Changes (§33.1 a)

        - SVIKT: Delay/failure by client (§33.1 b)

        - ANDRE: Other circumstances (§33.1 c)

        - FORCE_MAJEURE: Force majeure (§33.3)'
    SporStatus:
      type: string
      enum:
      - ikke_relevant
      - utkast
      - sendt
      - under_behandling
      - godkjent
      - delvis_godkjent
      - avslatt
      - under_forhandling
      - trukket
      - laast
      description: Status for each track (spor) in a case
    GrunnlagResponsResultat:
      type: string
      enum:
      - godkjent
      - delvis_godkjent
      - avslatt
      - frafalt
      description: 'BH''s assessment of grounds (ansvar):

        - godkjent: BH accepts responsibility

        - delvis_godkjent: BH partially accepts

        - avslatt: BH rejects responsibility

        - frafalt: BH withdraws instruction (§32.3 c, irregular changes only)'
    VederlagBeregningResultat:
      type: string
      enum:
      - godkjent
      - delvis_godkjent
      - avslatt
      - hold_tilbake
      description: 'BH''s assessment of compensation claim:

        - godkjent: BH accepts the claim

        - delvis_godkjent: BH partially accepts (disagreement on amount/method)

        - avslatt: BH rejects the claim

        - hold_tilbake: §30.2 withholding (missing estimate only)'
    FristBeregningResultat:
      type: string
      enum:
      - godkjent
      - delvis_godkjent
      - avslatt
      description: 'BH''s assessment of deadline extension claim:

        - godkjent: BH accepts the claim

        - delvis_godkjent: BH partially accepts (disagreement on days)

        - avslatt: BH rejects the claim'
    SubsidiaerTrigger:
      type: string
      enum:
      - grunnlag_avslatt
      - grunnlag_prekludert_32_2
      - forseringsrett_avslatt
      - preklusjon_hovedkrav
      - preklusjon_rigg
      - preklusjon_produktivitet
      - reduksjon_ep_justering
      - preklusjon_varsel
      - reduksjon_spesifisert
      - ingen_hindring
      - metode_avslatt
      description: 'Reasons for subsidiary assessment (when BH takes principal position
        but also states

        what the result would be if principal position doesn''t hold):

        - grunnlag_avslatt: BH rejected grounds

        - grunnlag_prekludert_32_2: Grounds notice too late (§32.2, ENDRING only)

        - forseringsrett_avslatt: TE has no acceleration right (§33.8)

        - preklusjon_*: Various late notice triggers (§34.1.2, §34.1.3, §33.4, §33.6)

        - ingen_hindring: No actual hindrance (§33.5)

        - metode_avslatt: BH rejects proposed method'
    GrunnlagData:
      description: 'Data for ansvarsgrunnlag (Event 1 - Hvorfor/Hvem).


        Denne modellen beskriver ÅRSAKEN til kravet og TE''s vurdering av ANSVAR.

        Kategoriseringen følger NS 8407 og bestemmer hvilke juridiske regler som gjelder.'
      properties:
        tittel:
          description: Kort beskrivende tittel for varselet (f.eks. 'Forsinket tegningsunderlag
            uke 45')
          minLength: 1
          title: Tittel
          type: string
        hovedkategori:
          description: Hovedkategori for ansvarsgrunnlag (f.eks. 'ENDRING', 'SVIKT')
          title: Hovedkategori
          type: string
        underkategori:
          anyOf:
          - type: string
          - items:
              type: string
            type: array
          - type: 'null'
          default: null
          description: Underkategori(er) - enkelt kode eller liste av koder. Valgfritt
            for kategorier uten underkategorier (f.eks. Force Majeure)
          title: Underkategori
        beskrivelse:
          description: Detaljert beskrivelse av forholdet som utløste kravet
          minLength: 1
          title: Beskrivelse
          type: string
        dato_oppdaget:
          description: Når forholdet ble oppdaget (YYYY-MM-DD)
          title: Dato Oppdaget
          type: string
        grunnlag_varsel:
          anyOf:
          - $ref: '#/$defs/VarselInfo'
          - type: 'null'
          default: null
          description: Info om når og hvordan BH ble varslet om forholdet
        kontraktsreferanser:
          description: Relevante kontraktsbestemmelser (f.eks. ['NS8407 §25.2', 'Kap.
            3.2'])
          items:
            type: string
          title: Kontraktsreferanser
          type: array
        vedlegg_ids:
          description: Referanser til vedlagte dokumenter (bilder, rapporter, etc.)
          items:
            type: string
          title: Vedlegg Ids
          type: array
      required:
      - tittel
      - hovedkategori
      - beskrivelse
      - dato_oppdaget
      title: GrunnlagData
      type: object
    VederlagData:
      description: 'Data for vederlagskrav (Entreprenørens krav).


        Arver fra VederlagKompensasjon som gir felles struktur for beløp/metode.

        Denne modellen utvider med TEs spesifikke dokumentasjon og varsler

        som kreves etter NS 8407.


        Arvede felter fra VederlagKompensasjon:

        - metode: VederlagsMetode

        - belop_direkte: For ENHETSPRISER/FASTPRIS_TILBUD

        - kostnads_overslag: For REGNINGSARBEID

        - fradrag_belop: Fradrag (§34.4)

        - er_estimat: Om beløpet er et estimat

        - netto_belop: Computed (brutto - fradrag)

        - krevd_belop: Alias for netto_belop'
      properties:
        metode:
          $ref: '#/$defs/VederlagsMetode'
          description: Vederlagsmetode etter NS 8407 (§34)
        belop_direkte:
          anyOf:
          - type: number
          - type: 'null'
          default: null
          description: 'For ENHETSPRISER/FASTPRIS_TILBUD: Beløp i NOK'
          title: Belop Direkte
        kostnads_overslag:
          anyOf:
          - minimum: 0
            type: number
          - type: 'null'
          default: null
          description: 'For REGNINGSARBEID (§30.2): Kostnadsoverslag i NOK'
          title: Kostnads Overslag
        fradrag_belop:
          anyOf:
          - minimum: 0
            type: number
          - type: 'null'
          default: null
          description: Fradrag i NOK (§34.4) - reduksjon for besparelser
          title: Fradrag Belop
        er_estimat:
          default: false
          description: Om beløpet er et estimat (endelig oppgjør senere)
          title: Er Estimat
          type: boolean
        begrunnelse:
          description: Begrunnelse for kravet
          minLength: 1
          title: Begrunnelse
          type: string
        vedlegg_ids:
          description: Referanser til vedlagte dokumenter
          items:
            type: string
          title: Vedlegg Ids
          type: array
        saerskilt_krav:
          anyOf:
          - $ref: '#/$defs/SaerskiltKrav'
          - type: 'null'
          default: null
          description: Særskilte krav for rigg/drift og/eller produktivitetstap (§34.1.3)
        rigg_drift_varsel:
          anyOf:
          - $ref: '#/$defs/VarselInfo'
          - type: 'null'
          default: null
          description: Varselinfo for rigg/drift (§34.1.3) - når og hvordan BH ble
            varslet
        krever_justert_ep:
          default: false
          description: Om kravet krever justering av kontraktens enhetspriser (§34.3.3)
          title: Krever Justert Ep
          type: boolean
        justert_ep_varsel:
          anyOf:
          - $ref: '#/$defs/VarselInfo'
          - type: 'null'
          default: null
          description: Varselinfo for justerte enhetspriser (§34.3.3)
        regningsarbeid_varsel:
          anyOf:
          - $ref: '#/$defs/VarselInfo'
          - type: 'null'
          default: null
          description: Varselinfo før start av regningsarbeid (§30.1) - BH må varsles
            FØR oppstart
        produktivitetstap_varsel:
          anyOf:
          - $ref: '#/$defs/VarselInfo'
          - type: 'null'
          default: null
          description: Varselinfo for produktivitetstap (§34.1.3, 2. ledd)
        krav_fremmet_dato:
          anyOf:
          - type: string
          - type: 'null'
          default: null
          description: Dato spesifisert vederlagskrav ble formelt fremmet (YYYY-MM-DD)
          title: Krav Fremmet Dato
        netto_belop:
          description: 'Beregner netto beløp basert på metode.


            For ENHETSPRISER/FASTPRIS_TILBUD: belop_direkte - fradrag

            For REGNINGSARBEID: kostnads_overslag - fradrag'
          readOnly: true
          title: Netto Belop
          type: number
        krevd_belop:
          description: 'Alias for netto_belop - brukes i state-modellen.

            Returnerer det totale kravet/kompensasjonen.'
          readOnly: true
          title: Krevd Belop
          type: number
      required:
      - metode
      - begrunnelse
      - netto_belop
      - krevd_belop
      title: VederlagData
      type: object
    FristData:
      description: "Data for fristforlengelseskrav (Entreprenørens krav).\n\nDenne\
        \ modellen støtter både varsel om fristforlengelse (§33.4) og spesifisert\
        \ krav (§33.6).\n\nNS 8407 skiller mellom:\n- Varsel om fristforlengelse (§33.4):\
        \ Varsler om at det *kan* bli krav, uten å spesifisere antall dager\n- Spesifisert\
        \ krav (§33.6.1): Konkret krav om X antall dager\n\nKOMMENTAR FRA ARKITEKT:\n\
        // Hvis spesifisert krav er for sent, sjekk om BH har sendt forespørsel\n\
        If (spesifisert_krav_ok == NEI) {\n   Field har_bh_foresporsel: Boolean {\n\
        \     Label: \"Har BH sendt forespørsel om spesifisering (§33.6.2)?\"\n  \
        \   Options: [JA, NEI]\n     Note: \"Hvis NEI, tapes ikke kravet helt, men\
        \ reduseres.\"\n   }\n}\n\nNB! Vi avventer med å ta det ovenfor med i modellen."
      properties:
        varsel_type:
          $ref: '#/$defs/FristVarselType'
          description: Type varsel sendt til BH
        frist_varsel:
          anyOf:
          - $ref: '#/$defs/VarselInfo'
          - type: 'null'
          default: null
          description: Info om varsel om fristforlengelse (§33.4) - dato + metode
        spesifisert_varsel:
          anyOf:
          - $ref: '#/$defs/VarselInfo'
          - type: 'null'
          default: null
          description: Info om spesifisert krav (§33.6) - dato + metode (f.eks. formelt
            brev/epost)
        antall_dager:
          anyOf:
          - minimum: 0
            type: integer
          - type: 'null'
          default: null
          description: Antall dager forlengelse (kun ved spesifisert krav)
          title: Antall Dager
        begrunnelse:
          description: Overordnet begrunnelse for fristkravet
          minLength: 1
          title: Begrunnelse
          type: string
        fremdriftshindring_dokumentasjon:
          anyOf:
          - type: string
          - type: 'null'
          default: null
          description: Dokumentasjon av fremdriftshindring (f.eks. påvirkning på fremdriftsplan,
            kritisk linje)
          title: Fremdriftshindring Dokumentasjon
        ny_sluttdato:
          anyOf:
          - type: string
          - type: 'null'
          default: null
          description: Foreslått ny sluttdato (YYYY-MM-DD)
          title: Ny Sluttdato
        vedlegg_ids:
          description: Referanser til vedlagte dokumenter (fremdriftsplan, fremdriftsanalyse,
            etc.)
          items:
            type: string
          title: Vedlegg Ids
          type: array
      required:
      - varsel_type
      - begrunnelse
      title: FristData
      type: object
    GrunnlagResponsData:
      description: 'Byggherrens respons på grunnlag/varsel.


        Dette er BH''s vurdering av ANSVARET - hvem sin feil er det?

        Hvis BH avviser grunnlaget her, kan Vederlag/Frist fortsatt vurderes subsidiært.


        Støtter partielle oppdateringer: Hvis original_respons_id er satt,

        er dette en oppdatering og kun feltene som sendes vil oppdateres.'
      properties:
        resultat:
          anyOf:
          - $ref: '#/$defs/GrunnlagResponsResultat'
          - type: 'null'
          default: null
          description: BHs vurdering av ansvarsgrunnlaget
        begrunnelse:
          anyOf:
          - type: string
          - type: 'null'
          default: null
          description: BHs begrunnelse for vurderingen
          title: Begrunnelse
        akseptert_kategori:
          anyOf:
          - type: string
          - type: 'null'
          default: null
          description: BH kan akseptere men kategorisere annerledes (f.eks. fra 'prosjektering'
            til 'arbeidsgrunnlag')
          title: Akseptert Kategori
        grunnlag_varslet_i_tide:
          anyOf:
          - type: boolean
          - type: 'null'
          default: null
          description: '§32.2: Var grunnlagsvarselet rettidig? Kun relevant for ENDRING-kategorien.'
          title: Grunnlag Varslet I Tide
        original_respons_id:
          anyOf:
          - type: string
          - type: 'null'
          default: null
          description: Event-ID til original respons som oppdateres (for RESPONS_*_OPPDATERT)
          title: Original Respons Id
      title: GrunnlagResponsData
      type: object
    VederlagResponsData:
      description: "Byggherrens respons på vederlagskrav (Port-modellen).\n\nVIKTIG:\
        \ Denne modellen beskriver KUN beregningen/utmålingen av penger.\nAvslag basert\
        \ på grunnlag (ansvar) håndteres i Grunnlag-sporet.\n\nDette muliggjør subsidiære\
        \ betraktninger:\n- BH kan avvise Grunnlag (ansvar), MEN samtidig godkjenne\
        \ beregningen\n  som subsidiær vurdering (\"hvis jeg hadde hatt ansvar, er\
        \ 50k riktig\").\n\nStøtter partielle oppdateringer: Hvis original_respons_id\
        \ er satt,\ner dette en oppdatering og kun feltene som sendes vil oppdateres."
      properties:
        original_respons_id:
          anyOf:
          - type: string
          - type: 'null'
          default: null
          description: Event-ID til original respons som oppdateres (for RESPONS_*_OPPDATERT)
          title: Original Respons Id
        vederlag_krav_id:
          anyOf:
          - type: string
          - type: 'null'
          default: null
          description: Event-ID til vederlagskravet som besvares
          title: Vederlag Krav Id
        hovedkrav_varslet_i_tide:
          anyOf:
          - type: boolean
          - type: 'null'
          default: null
          description: Er vederlagskravet varslet i tide? (§34.1.2) - kun relevant
            for SVIKT/ANDRE
          title: Hovedkrav Varslet I Tide
        rigg_varslet_i_tide:
          anyOf:
          - type: boolean
          - type: 'null'
          default: null
          description: Er rigg/drift-kravet varslet i tide? (§34.1.3)
          title: Rigg Varslet I Tide
        produktivitet_varslet_i_tide:
          anyOf:
          - type: boolean
          - type: 'null'
          default: null
          description: Er produktivitetskravet varslet i tide? (§34.1.3)
          title: Produktivitet Varslet I Tide
        begrunnelse_preklusjon:
          anyOf:
          - type: string
          - type: 'null'
          default: null
          description: Begrunnelse for preklusjonsvurdering
          title: Begrunnelse Preklusjon
        saerskilt_varsel_rigg_drift_ok:
          anyOf:
          - type: boolean
          - type: 'null'
          default: null
          description: 'DEPRECATED: Bruk rigg_varslet_i_tide'
          title: Saerskilt Varsel Rigg Drift Ok
        varsel_justert_ep_ok:
          anyOf:
          - type: boolean
          - type: 'null'
          default: null
          description: Er det varslet om justerte enhetspriser uten ugrunnet opphold?
            (§34.3.3)
          title: Varsel Justert Ep Ok
        varsel_start_regning_ok:
          anyOf:
          - type: boolean
          - type: 'null'
          default: null
          description: Ble BH varslet før regningsarbeid startet? (§30.1)
          title: Varsel Start Regning Ok
        krav_fremmet_i_tide:
          anyOf:
          - type: boolean
          - type: 'null'
          default: true
          description: Er vederlagskravet fremmet uten ugrunnet opphold?
          title: Krav Fremmet I Tide
        begrunnelse_varsel:
          anyOf:
          - type: string
          - type: 'null'
          default: null
          description: Begrunnelse for vurdering av varsler/frister
          title: Begrunnelse Varsel
        aksepterer_metode:
          anyOf:
          - type: boolean
          - type: 'null'
          default: null
          description: Aksepterer BH den foreslåtte vederlagsmetoden?
          title: Aksepterer Metode
        oensket_metode:
          anyOf:
          - $ref: '#/$defs/VederlagsMetode'
          - type: 'null'
          default: null
          description: Metode BH ønsker dersom foreslått metode ikke aksepteres
        ep_justering_akseptert:
          anyOf:
          - type: boolean
          - type: 'null'
          default: null
          description: Aksepterer BH justering av enhetspriser? (§34.3.3)
          title: Ep Justering Akseptert
        hold_tilbake:
          anyOf:
          - type: boolean
          - type: 'null'
          default: null
          description: Holder BH tilbake betaling? (§30.2)
          title: Hold Tilbake
        begrunnelse_metode:
          anyOf:
          - type: string
          - type: 'null'
          default: null
          description: Begrunnelse for metodevalg
          title: Begrunnelse Metode
        vederlagsmetode:
          anyOf:
          - $ref: '#/$defs/VederlagsMetode'
          - type: 'null'
          default: null
          description: Hvilken metode BH legger til grunn (legacy)
        hovedkrav_vurdering:
          anyOf:
          - $ref: '#/$defs/BelopVurdering'
          - type: 'null'
          default: null
          description: BHs vurdering av hovedkravet
        hovedkrav_godkjent_belop:
          anyOf:
          - type: number
          - type: 'null'
          default: null
          description: Godkjent beløp for hovedkravet i NOK
          title: Hovedkrav Godkjent Belop
        hovedkrav_begrunnelse:
          anyOf:
          - type: string
          - type: 'null'
          default: null
          description: Begrunnelse for hovedkravvurdering
          title: Hovedkrav Begrunnelse
        rigg_vurdering:
          anyOf:
          - $ref: '#/$defs/BelopVurdering'
          - type: 'null'
          default: null
          description: BHs vurdering av rigg/drift-kravet
        rigg_godkjent_belop:
          anyOf:
          - type: number
          - type: 'null'
          default: null
          description: Godkjent beløp for rigg/drift i NOK
          title: Rigg Godkjent Belop
        produktivitet_vurdering:
          anyOf:
          - $ref: '#/$defs/BelopVurdering'
          - type: 'null'
          default: null
          description: BHs vurdering av produktivitetskravet
        produktivitet_godkjent_belop:
          anyOf:
          - type: number
          - type: 'null'
          default: null
          description: Godkjent beløp for produktivitetstap i NOK
          title: Produktivitet Godkjent Belop
        beregnings_resultat:
          anyOf:
          - $ref: '#/$defs/VederlagBeregningResultat'
          - type: 'null'
          default: null
          description: BHs samlede vurdering av kravets størrelse
        total_godkjent_belop:
          anyOf:
          - type: number
          - type: 'null'
          default: null
          description: Totalt godkjent beløp i NOK (hovedkrav + særskilte krav)
          title: Total Godkjent Belop
        total_krevd_belop:
          anyOf:
          - type: number
          - type: 'null'
          default: null
          description: Totalt krevd beløp i NOK
          title: Total Krevd Belop
        begrunnelse:
          anyOf:
          - type: string
          - type: 'null'
          default: null
          description: Samlet begrunnelse
          title: Begrunnelse
        frist_for_spesifikasjon:
          anyOf:
          - type: string
          - type: 'null'
          default: null
          description: Frist for TE å levere ytterligere spesifikasjon (YYYY-MM-DD)
          title: Frist For Spesifikasjon
        subsidiaer_triggers:
          anyOf:
          - items:
              $ref: '#/$defs/SubsidiaerTrigger'
            type: array
          - type: 'null'
          default: null
          description: Liste over årsaker til subsidiær vurdering
          title: Subsidiaer Triggers
        subsidiaer_resultat:
          anyOf:
          - $ref: '#/$defs/VederlagBeregningResultat'
          - type: 'null'
          default: null
          description: Subsidiært beregningsresultat
        subsidiaer_godkjent_belop:
          anyOf:
          - type: number
          - type: 'null'
          default: null
          description: Subsidiært godkjent beløp i NOK (totalt)
          title: Subsidiaer Godkjent Belop
        subsidiaer_begrunnelse:
          anyOf:
          - type: string
          - type: 'null'
          default: null
          description: BH's begrunnelse for subsidiær vurdering
          title: Subsidiaer Begrunnelse
      title: VederlagResponsData
      type: object
    FristResponsData:
      description: "Byggherrens respons på fristforlengelseskrav (Port-modellen).\n\
        \nVIKTIG: Denne modellen beskriver KUN tid-vurderingen.\nAvslag basert på\
        \ grunnlag (ansvar) håndteres i Grunnlag-sporet.\n\nDette muliggjør subsidiære\
        \ betraktninger:\n- BH kan avvise Grunnlag (ansvar), MEN samtidig godkjenne\
        \ dagberegningen\n  som subsidiær vurdering (\"hvis jeg hadde hatt ansvar,\
        \ er 14 dager riktig\").\n\nPort-modellen med tre sekvensielle vurderinger:\n\
        1. PORT 1: Er varselet sendt i tide? (Preklusjon)\n2. PORT 2: Har forholdet\
        \ medført faktisk fremdriftshindring? (Vilkår)\n3. PORT 3: Hvor mange dager\
        \ godkjennes? (Utmåling)\n\nStøtter partielle oppdateringer: Hvis original_respons_id\
        \ er satt,\ner dette en oppdatering og kun feltene som sendes vil oppdateres."
      properties:
        original_respons_id:
          anyOf:
          - type: string
          - type: 'null'
          default: null
          description: Event-ID til original respons som oppdateres (for RESPONS_*_OPPDATERT)
          title: Original Respons Id
        frist_varsel_ok:
          anyOf:
          - type: boolean
          - type: 'null'
          default: null
          description: Er varsel om fristforlengelse sendt i tide? (§33.4). None hvis
            ikke relevant.
          title: Frist Varsel Ok
        spesifisert_krav_ok:
          default: true
          description: Er spesifisert krav sendt i tide? (§33.6)
          title: Spesifisert Krav Ok
          type: boolean
        foresporsel_svar_ok:
          anyOf:
          - type: boolean
          - type: 'null'
          default: null
          description: Er svar på forespørsel sendt i tide? (§33.6.2/§5). None hvis
            ikke relevant.
          title: Foresporsel Svar Ok
        har_bh_foresporsel:
          anyOf:
          - type: boolean
          - type: 'null'
          default: null
          description: Har BH sendt forespørsel om spesifisering? (§33.6.2). Relevant
            kun hvis krav er sent.
          title: Har Bh Foresporsel
        dato_bh_foresporsel:
          anyOf:
          - type: string
          - type: 'null'
          default: null
          description: Dato BH sendte forespørsel om spesifisering (§33.6.2) - YYYY-MM-DD.
            Brukes for å beregne om TEs svar kom i tide.
          title: Dato Bh Foresporsel
        begrunnelse_varsel:
          anyOf:
          - type: string
          - type: 'null'
          default: null
          description: BHs begrunnelse for vurdering av varsling
          title: Begrunnelse Varsel
        vilkar_oppfylt:
          default: true
          description: Har forholdet medført en faktisk fremdriftshindring? (§33.1)
          title: Vilkar Oppfylt
          type: boolean
        begrunnelse_vilkar:
          anyOf:
          - type: string
          - type: 'null'
          default: null
          description: BHs begrunnelse for vurdering av årsakssammenheng
          title: Begrunnelse Vilkar
        beregnings_resultat:
          anyOf:
          - $ref: '#/$defs/FristBeregningResultat'
          - type: 'null'
          default: null
          description: BHs vurdering av antall dager (ren beregning)
        godkjent_dager:
          anyOf:
          - type: integer
          - type: 'null'
          default: null
          description: Godkjent antall dager. Innvilges kun hvis Grunnlag også godkjennes.
          title: Godkjent Dager
        ny_sluttdato:
          anyOf:
          - type: string
          - type: 'null'
          default: null
          description: BH-godkjent ny sluttdato (YYYY-MM-DD)
          title: Ny Sluttdato
        begrunnelse:
          anyOf:
          - type: string
          - type: 'null'
          default: null
          description: Samlet begrunnelse
          title: Begrunnelse
        frist_for_spesifisering:
          anyOf:
          - type: string
          - type: 'null'
          default: null
          description: Frist for TE å levere ytterligere spesifikasjon/fremdriftsplan
            (YYYY-MM-DD)
          title: Frist For Spesifisering
        subsidiaer_triggers:
          anyOf:
          - items:
              $ref: '#/$defs/SubsidiaerTrigger'
            type: array
          - type: 'null'
          default: null
          description: Liste over årsaker til subsidiær vurdering
          title: Subsidiaer Triggers
        subsidiaer_resultat:
          anyOf:
          - $ref: '#/$defs/FristBeregningResultat'
          - type: 'null'
          default: null
          description: Subsidiært beregningsresultat
        subsidiaer_godkjent_dager:
          anyOf:
          - type: integer
          - type: 'null'
          default: null
          description: Subsidiært godkjent antall dager
          title: Subsidiaer Godkjent Dager
        subsidiaer_begrunnelse:
          anyOf:
          - type: string
          - type: 'null'
          default: null
          description: BH's begrunnelse for subsidiær vurdering
          title: Subsidiaer Begrunnelse
      title: FristResponsData
      type: object
    Error:
      type: object
      properties:
        success:
          type: boolean
          example: false
        error:
          type: string
          description: Error code
        message:
          type: string
          description: Human-readable message
        field:
          type: string
          description: Field that caused the error
        valid_options:
          type: object
          description: Valid options when validation fails
      required:
      - success
      - error
      - message
    VersionConflictError:
      type: object
      properties:
        success:
          type: boolean
          example: false
        error:
          type: string
          example: VERSION_CONFLICT
        expected_version:
          type: integer
        current_version:
          type: integer
        message:
          type: string
    ConcurrencyConflictError:
      type: object
      description: Returned when optimistic concurrency check fails (409)
      properties:
        success:
          type: boolean
          example: false
        error:
          type: string
          example: CONCURRENCY_CONFLICT
        message:
          type: string
          example: 'Versjonskonflikt: forventet 3, fikk 4'
        expected_version:
          type: integer
        actual_version:
          type: integer
    CatendaSyncStatus:
      type: object
      description: Status for Catenda synchronization (comment + status update)
      properties:
        catenda_synced:
          type: boolean
          description: Whether the event was successfully synced to Catenda
        catenda_comment_posted:
          type: boolean
          description: Whether a comment was posted to the Catenda topic
        catenda_status_updated:
          type: boolean
          description: Whether the topic status was updated in Catenda
        catenda_skipped_reason:
          type: string
          enum:
          - no_topic_id
          - not_authenticated
          - no_client
          - sync_not_attempted
          - error
          nullable: true
          description: Reason why sync was skipped (if catenda_synced=false)
        catenda_error:
          type: string
          nullable: true
          description: Error message if sync failed
    EventSubmission:
      type: object
      required:
      - sak_id
      - expected_version
      - event
      properties:
        sak_id:
          type: string
          example: SAK-20251218-001
          description: Case identifier
        expected_version:
          type: integer
          minimum: 0
          description: Expected current version (optimistic concurrency)
        event:
          $ref: '#/components/schemas/Event'
        catenda_topic_id:
          type: string
          format: uuid
          description: Optional Catenda topic GUID for PDF upload
        pdf_base64:
          type: string
          format: byte
          description: Optional client-generated PDF (base64)
        pdf_filename:
          type: string
          description: Optional PDF filename
    Event:
      type: object
      required:
      - event_type
      - aktor
      - aktor_rolle
      - data
      properties:
        event_type:
          $ref: '#/components/schemas/EventType'
        aktor:
          type: string
          description: Name of person performing the action
        aktor_rolle:
          type: string
          enum:
          - TE
          - BH
          description: 'Role: TE=Totalentreprenør, BH=Byggherre'
        data:
          type: object
          description: Event-specific data (GrunnlagData, VederlagData, etc.)
    EventSubmissionResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        event_id:
          type: string
          format: uuid
        new_version:
          type: integer
        state:
          type: object
          description: Computed case state after event
        pdf_uploaded:
          type: boolean
        pdf_source:
          type: string
          enum:
          - client
          - server
          nullable: true
    CaseStateResponse:
      type: object
      properties:
        version:
          type: integer
          description: Current version for optimistic concurrency
        state:
          type: object
          description: Computed case state
    CaseListItem:
      type: object
      properties:
        sak_id:
          type: string
          example: SAK-20251218-001
          description: Case identifier
        sakstype:
          type: string
          enum:
          - standard
          - forsering
          - endringsordre
          description: Case type
        cached_title:
          type: string
          nullable: true
          description: Cached case title
        cached_status:
          type: string
          nullable: true
          description: Cached overall status
        created_at:
          type: string
          format: date-time
          nullable: true
          description: Case creation timestamp
        created_by:
          type: string
          description: Email of creator
        last_event_at:
          type: string
          format: date-time
          nullable: true
          description: Timestamp of most recent event
    CaseListResponse:
      type: object
      properties:
        cases:
          type: array
          items:
            $ref: '#/components/schemas/CaseListItem'
          description: List of case metadata
    CloudEvent:
      type: object
      description: CloudEvents v1.0 structured content format
      required:
      - specversion
      - id
      - source
      - type
      properties:
        specversion:
          type: string
          example: '1.0'
          description: CloudEvents specification version
        id:
          type: string
          format: uuid
          description: Unique event identifier
        source:
          type: string
          example: /projects/P-2025-001/cases/KOE-2025-042
          description: 'Source URI: /projects/{prosjekt_id}/cases/{sak_id}'
        type:
          type: string
          example: no.oslo.koe.grunnlag_opprettet
          description: Event type with namespace
        time:
          type: string
          format: date-time
          description: Event timestamp in RFC 3339 format
        subject:
          type: string
          description: Subject identifier (sak_id)
        datacontenttype:
          type: string
          example: application/json
          description: Content type of data attribute
        dataschema:
          type: string
          format: uri
          description: URI to JSON Schema for data payload
        actor:
          type: string
          description: 'Extension: Name of person who performed the action'
        actorrole:
          type: string
          enum:
          - TE
          - BH
          description: 'Extension: Role (TE=Totalentreprenor, BH=Byggherre)'
        referstoid:
          type: string
          description: 'Extension: Reference to another event ID'
        data:
          type: object
          description: Event-specific data payload
    CloudEventsTimelineResponse:
      type: object
      description: 'Timeline response in CloudEvents format (Accept: application/cloudevents+json)'
      properties:
        version:
          type: integer
          description: Current version for optimistic concurrency
        events:
          type: array
          items:
            $ref: '#/components/schemas/CloudEvent'
          description: List of events in CloudEvents format
