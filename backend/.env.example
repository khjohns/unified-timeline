# ==============================================================================
# KOE Automation System - Environment Variables
# ==============================================================================
#
# Dette er en template for environment variables.
# Kopier denne filen til `.env` og fyll inn faktiske verdier.
#
# VIKTIG:
# - IKKE commit .env til git (er allerede i .gitignore)
# - Bruk sterke, tilfeldige secrets i produksjon
# - Roter secrets regelmessig
#
# VARIABLE EXPANSION (python-dotenv 1.2+):
# - ${VAR} = verdien av VAR
# - ${VAR:-default} = VAR hvis satt, ellers "default"
# - Eksempel: DATABASE_URL=postgres://${DB_HOST:-localhost}:${DB_PORT:-5432}/mydb
#
# ==============================================================================

# ------------------------------------------------------------------------------
# Security Secrets
# ------------------------------------------------------------------------------

# CSRF Protection Secret
# Brukes til å signere CSRF-tokens
# Generer med: python3 -c "import secrets; print(secrets.token_urlsafe(32))"
CSRF_SECRET=CHANGE_ME_USE_STRONG_RANDOM_STRING

# Catenda Webhook Secret Path
# Brukes til å autentisere webhook requests fra Catenda.
# NB: Catenda fjerner query parameters, derfor er secret en del av URL-path:
#   Webhook URL: https://your-url.com/webhook/catenda/{WEBHOOK_SECRET_PATH}
# Generer med: python3 -c "import secrets; print(secrets.token_urlsafe(32))"
WEBHOOK_SECRET_PATH=CHANGE_ME_USE_STRONG_RANDOM_STRING

# ------------------------------------------------------------------------------
# Catenda API Configuration
# ------------------------------------------------------------------------------

# Catenda integration toggle (optional)
# - Not set or empty: auto-detect based on credentials
# - "true": force enable (will fail if credentials missing)
# - "false": disable even if credentials exist
CATENDA_ENABLED=

# Catenda OAuth Credentials
# Få disse fra Catenda Developer Portal: https://developer.catenda.com
# Eller kjør: python scripts/setup_authentication.py
CATENDA_CLIENT_ID=your_client_id_here
CATENDA_CLIENT_SECRET=your_client_secret_here

# Catenda Project and Library IDs
# Finner du i Catenda URL: https://app.catenda.com/projects/{PROJECT_ID}/...
CATENDA_PROJECT_ID=your_project_id_here
CATENDA_LIBRARY_ID=your_library_id_here

# ------------------------------------------------------------------------------
# Catenda API Retry Configuration (optional)
# ------------------------------------------------------------------------------
# Enables automatic retry for transient failures (429, 5xx, timeouts)
CATENDA_RETRY_ENABLED=true
CATENDA_RETRY_MAX_ATTEMPTS=3
CATENDA_RETRY_BACKOFF_BASE=0.5
CATENDA_RETRY_BACKOFF_MAX=60
CATENDA_RETRY_JITTER=true
CATENDA_REQUEST_TIMEOUT=30

# ------------------------------------------------------------------------------
# Catenda OAuth Tokens (generert av setup_authentication.py)
# ------------------------------------------------------------------------------

# Access token for API-kall (genereres automatisk)
CATENDA_ACCESS_TOKEN=

# Refresh token for å fornye access token (genereres automatisk)
CATENDA_REFRESH_TOKEN=

# Redirect URI for OAuth callback (må matche Catenda Developer Portal)
CATENDA_REDIRECT_URI=http://localhost:8080/callback

# ------------------------------------------------------------------------------
# Frontend URL Configuration
# ------------------------------------------------------------------------------

# URL til React-appen (for magic links i Catenda-kommentarer)
# DEV_REACT_APP_URL har prioritet over REACT_APP_URL
DEV_REACT_APP_URL=http://localhost:3000
REACT_APP_URL=

# ------------------------------------------------------------------------------
# CORS Configuration
# ------------------------------------------------------------------------------

# Tillatte origins for CORS (kommaseparert liste)
# For utvikling: localhost
# For produksjon: faktiske domener
ALLOWED_ORIGINS=http://localhost:3000,http://127.0.0.1:3000

# ngrok URL (oppdateres automatisk når ngrok starter)
# Eksempel: https://abc123.ngrok.io
NGROK_URL=

# ------------------------------------------------------------------------------
# Rate Limiting (optional - standardverdier er OK for prototype)
# ------------------------------------------------------------------------------

# Rate limit for API submissions (per minutt)
RATE_LIMIT_SUBMIT=10

# Rate limit for webhooks (per minutt)
RATE_LIMIT_WEBHOOK=100

# Rate limit for MCP endpoints (per minutt)
RATE_LIMIT_MCP=120

# Rate limit storage backend
# Prototype: memory:// (default, data tapt ved restart)
# Produksjon: bruk Redis URL med variable expansion
# RATE_LIMIT_STORAGE=redis://${REDIS_HOST:-localhost}:${REDIS_PORT:-6379}
RATE_LIMIT_STORAGE=memory://

# Rate limit strategy (Flask-Limiter 4.x)
# - fixed-window: Enkleste, lavest ressursbruk (default)
# - moving-window: Mer nøyaktig, høyere ressursbruk (krever Redis)
# - sliding-window-counter: Balanse mellom de to
RATE_LIMIT_STRATEGY=fixed-window

# Rate limit headers i API-responses (true/false)
# Når aktivert, legges følgende headers til:
# - X-RateLimit-Limit: Maks antall requests i vinduet
# - X-RateLimit-Remaining: Gjenstående requests
# - X-RateLimit-Reset: Unix timestamp for nullstilling
# - Retry-After: Sekunder til neste request (kun ved 429)
RATE_LIMIT_HEADERS_ENABLED=true

# Meta limits - overordnet beskyttelse mot misbruk
# Blokkerer klienter som bryter rate limits for ofte
# Format: "antall per periode" (kommaseparert)
# Tom = deaktivert
RATE_LIMIT_META=10 per hour, 50 per day

# Paths unntatt fra rate limiting (kommaseparert)
# Health checks, metrics, og andre interne endpoints
RATE_LIMIT_EXEMPT_PATHS=/health,/ready,/metrics

# IP-adresser unntatt fra rate limiting (kommaseparert)
# Localhost og interne tjenester
RATE_LIMIT_EXEMPT_IPS=127.0.0.1,::1

# ------------------------------------------------------------------------------
# Redis (optional - for produksjon)
# ------------------------------------------------------------------------------
#
# python-dotenv 1.2+ støtter variable expansion med defaults:
#   ${VAR:-default} = bruk VAR hvis satt, ellers "default"
#
# Dette lar deg bygge URL-er dynamisk fra komponenter.

# Redis connection components (sett disse i produksjon)
REDIS_HOST=
REDIS_PORT=6379
REDIS_PASSWORD=
REDIS_SSL=false

# Redis URL bygget fra komponenter (variable expansion)
# Lokal utvikling: redis://localhost:6379
# Azure Redis: sett REDIS_HOST, REDIS_PORT=6380, REDIS_PASSWORD, REDIS_SSL=true
# REDIS_URL=redis://${REDIS_HOST:-localhost}:${REDIS_PORT:-6379}

# Idempotency TTL i timer (hvor lenge webhook events huskes)
IDEMPOTENCY_TTL_HOURS=24

# ------------------------------------------------------------------------------
# Logging (optional)
# ------------------------------------------------------------------------------

# Log level: DEBUG, INFO, WARNING, ERROR, CRITICAL
LOG_LEVEL=INFO

# Audit log file path
AUDIT_LOG_FILE=audit.log

# ------------------------------------------------------------------------------
# Flask Configuration (optional)
# ------------------------------------------------------------------------------

# Flask Secret Key (for sessions)
# Generer med: python3 -c "import secrets; print(secrets.token_hex(32))"
FLASK_SECRET_KEY=CHANGE_ME_USE_STRONG_RANDOM_STRING

# Flask 3.1+: Secret Key Fallbacks for key rotation
# Når du roterer SECRET_KEY, legg gamle nøkler her (kommaseparert)
# Dette holder eksisterende sessions gyldige under rotasjon
# Eksempel: FLASK_SECRET_KEY_FALLBACKS=old_key_1,old_key_2
FLASK_SECRET_KEY_FALLBACKS=

# Flask Environment: development eller production
FLASK_ENV=development

# Flask Debug Mode (True/False)
# VIKTIG: Sett til False i produksjon!
FLASK_DEBUG=True

# Log format: "json" (produksjon/Azure Application Insights) eller "text" (utvikling)
# JSON gir strukturerte logger som er søkbare i Azure
LOG_FORMAT=text

# ------------------------------------------------------------------------------
# Flask 3.1+ Security Limits (optional - gode defaults)
# ------------------------------------------------------------------------------

# Maks minne for form-data (bytes) - beskytter mot DoS
# Default: 512000 (500KB)
# MAX_FORM_MEMORY_SIZE=512000

# Maks antall form-felter/filer - beskytter mot DoS
# Default: 1000
# MAX_FORM_PARTS=1000

# Maks størrelse på uploads (bytes)
# Default: 16777216 (16MB)
# MAX_CONTENT_LENGTH=16777216

# ------------------------------------------------------------------------------
# Entra ID / IDA - Oslo kommunes identitetstjeneste
# ------------------------------------------------------------------------------
#
# IDA er Oslo kommunes sentraliserte tjeneste for tilgangsstyring.
# Konfigurasjon mottas fra IDA-forvaltning etter bestilling via Kompass.
# Se docs/DEPLOYMENT.md for bestillingsveiledning.
#
# VIKTIG: Alle verdier hentes fra IDA etter kartleggingsmøte.
#

# Aktiver Entra ID-autentisering (sett til true når IDA er konfigurert)
ENTRA_ENABLED=false

# Azure AD Tenant ID (fra IDA)
# Eksempel: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
ENTRA_TENANT_ID=

# Application (client) ID (fra IDA app registration)
# Eksempel: yyyyyyyy-yyyy-yyyy-yyyy-yyyyyyyyyyyy
ENTRA_CLIENT_ID=

# Issuer URL (valgfritt - kan bygges med variable expansion)
# Standard: https://login.microsoftonline.com/{tenant_id}/v2.0
# ENTRA_ISSUER=https://login.microsoftonline.com/${ENTRA_TENANT_ID}/v2.0

# ------------------------------------------------------------------------------
# Database - Supabase PostgreSQL
# ------------------------------------------------------------------------------

# Supabase Project URL
# Get from: Supabase Dashboard → Settings → API → Project URL
SUPABASE_URL=https://your-project.supabase.co

# Supabase Secret Key (service role)
# Get from: Supabase Dashboard → Settings → API → API Keys
SUPABASE_KEY=sb_secret_...

# Supabase Publishable Key (for OAuth auto-consent flow)
SUPABASE_PUBLISHABLE_KEY=sb_publishable_...

# Supabase JWT Secret (for validating frontend auth tokens)
# Get from: Supabase Dashboard → Settings → API → JWT Secret
SUPABASE_JWT_SECRET=your-jwt-secret

# Event store backend: "csv" (local), "supabase" (production)
EVENT_STORE_BACKEND=supabase

# Metadata store backend: "csv" (local), "supabase" (production)
METADATA_STORE_BACKEND=supabase

# ------------------------------------------------------------------------------
# Dalux Integration
# ------------------------------------------------------------------------------

# Dalux integration toggle (optional)
# - Not set or empty: auto-detect based on API key
# - "true": force enable (will fail if API key missing)
# - "false": disable even if API key exists
DALUX_ENABLED=

# Dalux API key (required for sync)
# Get from: Dalux Admin → Firmaadministrator → API Identities
# Note: Old API keys expire 28 Feb 2026 - use new API identities
# DALUX_API_KEY=your_api_key_here

# Dalux API base URL (customer-specific, get from Dalux support)
# DALUX_BASE_URL=

# ------------------------------------------------------------------------------
# Generering av secrets
# ------------------------------------------------------------------------------
#
# Bruk disse kommandoene til å generere sterke secrets:
#
# 32-byte URL-safe token:
#   python3 -c "import secrets; print(secrets.token_urlsafe(32))"
#
# 64-byte hex token:
#   python3 -c "import secrets; print(secrets.token_hex(32))"
#
# UUID:
#   python3 -c "import uuid; print(uuid.uuid4())"
#
# ==============================================================================
